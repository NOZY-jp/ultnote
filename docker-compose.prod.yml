services:
  nginx:
    image: nginx:alpine
    container_name: ultnote-nginx
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - frontend
    restart: always
    networks:
      - ultnote

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: ultnote-frontend
    environment:
      - API_URL=http://api:8080
    depends_on:
      - api
    restart: always
    networks:
      - ultnote

  api:
    build:
      context: ./api
      dockerfile: Dockerfile
    container_name: ultnote-api
    environment:
      - QDRANT_URL=http://qdrant:6334
      - EMBEDDER_URL=http://embedder:8000
      - RUST_LOG=info
      - CF_TEAM_DOMAIN=${CF_TEAM_DOMAIN}
      - CF_POLICY_AUD=${CF_POLICY_AUD}
    depends_on:
      - qdrant
      - embedder
    restart: always
    networks:
      - ultnote

  embedder:
    build:
      context: ./embedder
      dockerfile: Dockerfile
    container_name: ultnote-embedder
    volumes:
      - huggingface_cache:/root/.cache/huggingface
    restart: always
    networks:
      - ultnote

  qdrant:
    image: qdrant/qdrant:latest
    container_name: ultnote-qdrant
    volumes:
      - qdrant_data:/qdrant/storage
    restart: always
    networks:
      - ultnote

  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: ultnote-cloudflared
    command: tunnel run
    environment:
      - TUNNEL_TOKEN=${CLOUDFLARE_TUNNEL_TOKEN}
    depends_on:
      - nginx
    restart: always
    networks:
      - ultnote

networks:
  ultnote:
    driver: bridge

volumes:
  qdrant_data:
  huggingface_cache:
