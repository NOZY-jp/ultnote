services:
  # 1. ベクトルデータベース (Qdrant)
  qdrant:
    image: qdrant/qdrant:latest
    container_name: notebook-qdrant
    ports:
      - "6333:6333" # API Port
      - "6334:6334" # GRPC Port
    volumes:
      - ./qdrant_data:/qdrant/storage
    restart: always

  # 2. AI Engine (Python + FastAPI)
  ai-engine:
    build:
      context: ./ai-engine
    container_name: notebook-ai-engine
    ports:
      - "5000:8000" # Host:5000 -> Container:8000
    volumes:
      - ./ai-engine:/app
      # モデルのダウンロード時間を短縮するためにホストのキャッシュを共有
      - ~/.cache/huggingface:/root/.cache/huggingface
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: 1
    #           capabilities: [gpu]
    # GPUがない環境(Macなど)でエラーになる場合は deploy ブロックをコメントアウトしてください
    restart: always
    command: uvicorn main:app --host 0.0.0.0 --port 8000 --reload

  # 3. SQLデータベース (PostgreSQL)
  db:
    image: postgres:16-alpine
    container_name: notebook-postgres
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      POSTGRES_DB: notebook_db
    volumes:
      - ./pg_data:/var/lib/postgresql/data
    restart: always
