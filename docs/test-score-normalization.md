# スコア正規化テスト

日付: 2026-01-09

## 問題

検索スコアが78%~81%の狭い範囲に集中しており、直感的でない。

## ベースライン (変更前)

設定: Distance::Cosine, normalize_embeddings=True, 生スコアをそのまま表示

| Query | Best Score | Worst Score | Range |
|-------|------------|-------------|-------|
| 歯科医 | 88.4% | 78.8% | 9.5% |
| クリニック | 83.8% | 80.0% | 3.8% |
| 量子物理学 | 78.8% | 77.1% | 1.7% |
| 買い物 | 85.5% | 80.2% | 5.3% |
| 仕事のドキュメント | 82.3% | 78.8% | 3.5% |
| 歯医者に行く予定がある | 93.9% | 80.3% | 13.6% |

**問題点**: 無関係な検索でも77%以上のスコアが出る

## Test 1: Distance::Dot

変更点: Distance::Cosine → Distance::Dot

| Query | Best Score | Worst Score | Range |
|-------|------------|-------------|-------|
| 歯科医 | 88.4% | 78.5% | 9.9% |
| クリニック | 85.0% | 78.1% | 6.9% |
| 量子物理学 | 79.9% | 76.8% | 3.1% |

**結論**: ほぼ変化なし。正規化ベクトルではDotとCosineは同等。

## Test 2: normalize_embeddings=False

変更点: normalize_embeddings=True → False

| Query | Best Score | Worst Score | Range |
|-------|------------|-------------|-------|
| 歯科医 | 0.88 | 0.79 | 0.10 |
| 量子物理学 | 0.80 | 0.77 | 0.03 |

**結論**: ほぼ変化なし。

## Test 3: Distance::Euclid

変更点: Distance::Cosine → Distance::Euclid

| Query | Best (dist) | Worst (dist) | Range |
|-------|-------------|--------------|-------|
| 歯科医 | 0.4824 | 0.6556 | 0.1731 |
| 量子物理学 | 0.6342 | 0.6807 | 0.0465 |
| 歯医者に行く予定がある | 0.3499 | 0.6408 | 0.2909 |

**結論**: 距離として返されるため、低いほど良い。差は若干広がるが、変換が必要。

## Test 4: スコア正規化 (バックエンド側)

### Test 4a: baseline=0.75, linear

```rust
let baseline = 0.75;
let normalized_score = ((point.score - baseline) / (1.0 - baseline)).clamp(0.0, 1.0);
```

| Query | Best Score | Worst Score | Range |
|-------|------------|-------------|-------|
| 歯科医 | 53.4% | 14.0% | 39.4% |
| 量子物理学 | 19.6% | 7.3% | 12.2% |
| 歯医者に行く予定がある | 75.5% | 17.9% | 57.6% |

**結論**: 大幅改善！範囲が広がった。

### Test 4b: baseline=0.70, linear

| Query | Best Score | Worst Score | Range |
|-------|------------|-------------|-------|
| 歯科医 | 61.2% | 28.4% | 32.8% |
| 量子物理学 | 33.0% | 22.8% | 10.2% |
| 歯医者に行く予定がある | 79.6% | 31.6% | 48.0% |

### Test 4c: baseline=0.70, pow=0.6

```rust
let linear = ((point.score - baseline) / (1.0 - baseline)).clamp(0.0, 1.0);
let normalized_score = linear.powf(0.6);
```

| Query | Best Score | Worst Score | Range |
|-------|------------|-------------|-------|
| 歯科医 | 74.5% | 47.0% | 27.5% |
| 量子物理学 | 51.4% | 41.2% | 10.2% |
| 歯医者に行く予定がある | 87.2% | 50.1% | 37.1% |

### Test 4d: baseline=0.75, pow=0.5

| Query | Best Score | Worst Score | Range |
|-------|------------|-------------|-------|
| 歯科医 | 73.1% | 37.5% | 35.6% |
| 量子物理学 | 44.2% | 27.1% | 17.1% |
| 歯医者に行く予定がある | 86.9% | 42.3% | 44.6% |

### Test 4e: baseline=0.77, pow=0.5 ✅ 採用

| Query | Best Score | Worst Score | Range |
|-------|------------|-------------|-------|
| 歯科医 | 70.3% | 25.6% | 44.7% |
| クリニック | 59.0% | 21.8% | 37.2% |
| 量子物理学 | 35.4% | 0.0% | 35.4% |
| 買い物 | 60.6% | 24.9% | 35.7% |
| 仕事のドキュメント | 48.0% | 23.6% | 24.4% |
| 歯医者に行く予定がある | 85.7% | 32.8% | 52.9% |

**結論**: 最良の結果。無関係な検索で0%が出るようになり、スコアの差が明確に。

## 最終設定

```rust
// api/src/services/qdrant.rs
let baseline = 0.77_f32;
let linear = ((point.score - baseline) / (1.0 - baseline)).clamp(0.0, 1.0);
let normalized_score = linear.powf(0.5);
```

## 比較サマリー

| テスト | 完全一致 | 意味的一致 | 無関係 |
|--------|---------|-----------|--------|
| 元 (Cosine) | 94% ~ 80% | 88% ~ 79% | 79% ~ 77% |
| 採用 (baseline=0.77, pow=0.5) | 86% ~ 33% | 70% ~ 26% | 35% ~ 0% |
