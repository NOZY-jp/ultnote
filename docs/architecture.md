# UltNote アーキテクチャ設計書

## 目次

1. [プロジェクト概要](#1-プロジェクト概要)
2. [ユーザー要件](#2-ユーザー要件)
3. [機能仕様](#3-機能仕様)
4. [技術スタック](#4-技術スタック)
5. [データモデル](#5-データモデル)
6. [API 設計](#6-api-設計)
7. [検索システム](#7-検索システム)
8. [認証・認可](#8-認証認可)
9. [UI/UX 設計](#9-uiux-設計)
10. [インフラストラクチャ](#10-インフラストラクチャ)
11. [開発方針](#11-開発方針)
12. [設計上の決定事項とその理由](#12-設計上の決定事項とその理由)

---

## 1. プロジェクト概要

### 1.1 ビジョン

ちょっとした雑多なことをメモして、あとからあいまい検索で見つけられるウェブアプリケーション。

### 1.2 コンセプト

- 「クリニック」と検索したら「歯医者いく予定」がヒットする
- 「今週の予定」と検索したら今週の日付メタデータを持つメモがヒットする
- 「みりん買う」というTODOが関連検索でヒットする

### 1.3 ポジショニング

- **個人用メモアプリ**：自分自身と認証された少数のユーザーが利用
- **ポートフォリオ**：企業に公開し、技術力をアピールするためのデモとしても機能

---

## 2. ユーザー要件

### 2.1 ターゲットユーザー

| ユーザー種別 | 説明 | 権限 |
|-------------|------|------|
| オーナー（自分） | 主要利用者 | 全機能利用可能 |
| 認証済みユーザー | Cloudflare Accessで認証された人物 | 全機能利用可能 |
| デモユーザー | 未認証でアクセスした人（企業の採用担当者等） | デモデータの検索のみ |

### 2.2 利用シナリオ

#### 日常的なメモ
- 買い物リスト（「牛乳買う」「みりん買う」）
- 予定のメモ（「来週火曜歯医者」）
- 思いついたアイデア
- 後で調べたいこと

#### 検索シナリオ
- 「クリニック」→ 歯医者、病院関連のメモがヒット（意味的類似性）
- 「今週の予定」→ 日付フィルタで今週の範囲を指定して検索
- 「買い物」→ 買い物関連のメモが全てヒット

### 2.3 非機能要件

| 要件 | 詳細 |
|------|------|
| 応答速度 | 検索結果は200ms以下で返却（Google検索程度の体感速度） |
| スケーラビリティ | 10,000件以上のメモに対応（現実的には1,000件程度を想定） |
| 可用性 | オンラインのみ（オフライン対応は不要） |
| モバイル対応 | 必須。スマホからのメモ追加・検索の需要が高い |

---

## 3. 機能仕様

### 3.1 優先度定義

| 優先度 | 定義 |
|--------|------|
| P0 | MVP（最小限の製品）に必須 |
| P1 | あると嬉しい機能 |
| P2 | 後で実装する機能 |

### 3.2 P0 機能（必須）

#### 3.2.1 メモ管理

| 機能 | 説明 |
|------|------|
| メモ追加 | 本文を入力してメモを作成 |
| メモ取得 | IDを指定してメモを取得 |
| メモ更新 | 既存メモの内容を編集 |
| メモ削除 | メモを削除（管理画面から） |

#### 3.2.2 メモ種別

| 種別 | 説明 | 挙動 |
|------|------|------|
| フラッシュメモ | 一時的なメモ | 日付経過後1週間でアーカイブへ自動移動、または完了マークでアーカイブへ |
| 永続メモ | 恒久的なメモ | 自動削除・移動なし |

登録時にフラッシュメモか永続メモかを**簡単に選択できる**UIを提供する。

#### 3.2.3 ベクトル検索

| 項目 | 詳細 |
|------|------|
| 検索方式 | 埋め込みベクトルによる意味的類似性検索 |
| モデル | multilingual-e5-base（278M params） |
| 検索対象 | メモ本文 |
| 除外 | メタデータはベクトル検索の対象外（フィルタで対応） |

#### 3.2.4 日付フィルタ

| 機能 | 説明 |
|------|------|
| 範囲指定 | from〜until の日付範囲でフィルタ |
| ワンクリック追加 | 「今日」「明日」「今週」「来週」「今月」ボタン |
| フィルタフィールド | 検索UIにフィルタフィールドを設置 |

**重要な設計判断**：
- 「今週の予定」というクエリを自然言語処理で解釈することは**しない**
- 日付検索は明示的なUIフィルタで行う
- ベクトル検索は純粋にテキストの意味的類似性のみ

#### 3.2.5 階層タグシステム

| 項目 | 詳細 |
|------|------|
| 形式 | スラッシュ区切り（`健康/歯医者/虫歯`） |
| 階層深度 | 無制限 |
| 検索挙動 | 親タグで検索すると子タグも全てヒット |
| 表示形式 | ツリービュー（フォルダ的に展開） |

**検索例**：
- `健康` で検索 → `健康/歯医者`、`健康/運動` 全てヒット
- `健康/歯医者` で検索 → `健康/歯医者/虫歯`、`健康/歯医者/インプラント` 全てヒット

**タグ入力UI**：
- タグ入力欄を設置
- 入力中に既存タグの予測変換を表示
- コンマで区切るとブロック化
- ブロックにホバーで×表示、クリックで削除
- Backspaceでも直前のタグを削除可能
- **参考UI**：Google Docsの編集者追加画面

#### 3.2.6 Cloudflare Access認証

| 項目 | 詳細 |
|------|------|
| 認証方式 | Google OAuth（無料優先） |
| 認証基盤 | Cloudflare Access |
| JWT検証 | `Cf-Access-Jwt-Assertion` ヘッダーをサーバーサイドで検証 |

#### 3.2.7 デモモード

| 項目 | 詳細 |
|------|------|
| 判定条件 | JWTがない or 無効 → デモモード |
| 機能制限 | 検索のみ可能、メモ追加不可 |
| データ | デモ専用コレクションから検索 |
| 目的 | ポートフォリオとして企業に見せる |

**デモデータの内容**：
- 架空の日常メモ（「牛乳買う」「歯医者予約」等）
- アプリの機能説明的なメモ
- 検索誘導テキスト（「こうやって検索してね」的な案内）

#### 3.2.8 モバイル対応

| 項目 | 詳細 |
|------|------|
| 対応方式 | レスポンシブデザイン |
| 必須理由 | スマホからのメモ追加・検索需要が高い |
| PWA | 通知機能は不要（別アプリAckunityで対応予定） |

### 3.3 P1 機能（あると嬉しい）

#### 3.3.1 アーカイブ自動移動

| 条件 | 挙動 |
|------|------|
| 日付メタデータ経過後1週間 | アーカイブコレクションへ移動 |
| 完了マーク付与 | アーカイブコレクションへ移動 |

#### 3.3.2 アクセス頻度ランキング

検索結果のスコアリングに以下を加味：
1. 意味的な近さ（ベクトル類似度）
2. アクセス頻度（よく見るものが上）
3. 作成日時（新しいものが上）

#### 3.3.3 タグ予測変換

タグ入力時に既存タグをサジェスト表示。

### 3.4 P2 機能（後で）

#### 3.4.1 カスタムメタデータ

| 項目 | 詳細 |
|------|------|
| 形式 | `{ key: value, key2: [value2-1, value2-2, value2-3] }` |
| 検索 | キーの存在検索、キー+値の完全一致検索 |

#### 3.4.2 アーカイブ検索

| 項目 | 詳細 |
|------|------|
| 検索対象 | アーカイブコレクション |
| UI | 別画面（「アーカイブを含めて検索」ではなく「アーカイブから検索」） |
| 復元 | 不可（一方通行） |

---

## 4. 技術スタック

### 4.1 全体構成

| レイヤー | 技術 | 備考 |
|----------|------|------|
| Frontend | SvelteKit + SCSS | SSRモード |
| Web Server | Nginx | 静的ファイル配信 + リバースプロキシ |
| API | Rust (Axum + eyre) | メインのビジネスロジック、エラーハンドリングにeyre使用 |
| Embedder | Python (FastAPI) | ベクトル化専用サービス |
| Vector DB | Qdrant | 全データを格納（PostgreSQL不使用） |
| 認証 | Cloudflare Access | Google OAuth |
| インフラ | Docker Compose | Proxmox VM (Ubuntu) 上で稼働 |
| トンネル | Cloudflare Tunnel | ultnote.com へ公開 |
| ドメイン | Cloudflare Registrar | ultnote.com を管理 |

### 4.2 技術選定の理由

#### SvelteKit
- 試してみたいという意向
- SSRによるSEO対応（ポートフォリオとして重要）
- 軽量で高速

#### SCSS
- CSSプリプロセッサとして一択
- 変数管理、ネスト、ミックスインの活用

#### Rust (Axum)
- 高速な実行性能
- 型安全性
- メインのビジネスロジックを担当
- エラーハンドリング: `eyre` + `color-eyre` を使用
  - リッチなエラーレポート
  - スタックトレースの可視化
  - コンテキスト追加（`.wrap_err()`）

#### Python (FastAPI)
- 埋め込みモデル（sentence-transformers）のエコシステム
- ベクトル化処理のみを担当
- Rustから内部HTTPで呼び出し

#### Qdrant
- ベクトル検索に特化
- payloadでメタデータも格納可能 → PostgreSQL不要
- セルフホスト可能

#### Cloudflare Access
- 既存のCloudflare環境との統合
- 無料枠あり
- Google OAuth対応

### 4.3 LLMを避ける理由

| 理由 | 詳細 |
|------|------|
| 依存関係 | 外部サービスへの依存を最小化したい |
| コスト | 従量課金を避けたい |
| 方針 | 埋め込みモデルはローカル実行で対応 |

---

## 5. データモデル

### 5.1 Qdrant コレクション設計

Qdrantはベクトル + payload（JSONメタデータ）を格納できるため、**Qdrant一本**で全データを管理する。

#### 5.1.1 memos コレクション（アクティブメモ）

```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "vector": [0.123, -0.456, ...],  // 768次元 (multilingual-e5-base)
  "payload": {
    "content": "歯医者に行く",
    "type": "flash",  // "flash" | "permanent"
    "from": "2026-01-15",  // 開始日（nullable）
    "until": "2026-01-20",  // 終了日（nullable）
    "tags": ["健康/歯医者", "予定"],
    "custom_meta": {
      "priority": "high",
      "urls": ["https://example.com"]
    },
    "date_added": "2026-01-09T10:30:00Z",
    "access_count": 5,
    "last_accessed": "2026-01-10T14:20:00Z",
    "completed": false
  }
}
```

#### 5.1.2 memos_archive コレクション（アーカイブ）

スキーマは `memos` と同一。検索対象から分離。

#### 5.1.3 memos_demo コレクション（デモ用）

スキーマは `memos` と同一。未認証ユーザーの検索対象。

#### 5.1.4 tags コレクション（タグマスター）

```json
{
  "id": "660e8400-e29b-41d4-a716-446655440001",
  "vector": null,  // ベクトルなし（メタデータのみ）
  "payload": {
    "path": "健康/歯医者",
    "created_at": "2026-01-09T10:30:00Z",
    "usage_count": 15
  }
}
```

**注意**: Qdrantはベクトルなしのコレクションも作成可能だが、検索効率のためタグは別管理とする。

### 5.2 フィールド詳細

| フィールド | 型 | 必須 | 説明 |
|-----------|------|------|------|
| id | UUID | ✓ | 一意識別子 |
| content | String | ✓ | メモ本文（ベクトル化対象） |
| type | Enum | ✓ | "flash" or "permanent" |
| from | Date | - | 開始日（日付フィルタ用） |
| until | Date | - | 終了日（日付フィルタ用） |
| tags | Array[String] | - | タグリスト（階層はスラッシュ区切り） |
| custom_meta | Object | - | ユーザー定義メタデータ（P2） |
| date_added | DateTime | ✓ | 作成日時（自動設定） |
| access_count | Integer | ✓ | アクセス回数（初期値0） |
| last_accessed | DateTime | ✓ | 最終アクセス日時 |
| completed | Boolean | ✓ | 完了フラグ（初期値false） |

### 5.3 Qdrant Payloadフィルタの制限

| 可能な操作 | 例 |
|-----------|-----|
| 完全一致 | `tags contains "健康"` |
| 範囲検索 | `from >= "2026-01-10"` |
| 前方一致（タグ階層） | `tags starts_with "健康/"` |

| **不可能な操作** | 代替手段 |
|-----------------|----------|
| 全文検索（部分一致） | ベクトル検索で代替 |

---

## 6. API 設計

### 6.1 Rust (Axum) エンドポイント

#### 6.1.1 ヘルスチェック

```
GET /health
```

レスポンス:
```json
{
  "status": "ok",
  "version": "1.0.0"
}
```

#### 6.1.2 メモ操作

```
POST   /memo          メモ追加
GET    /memo/{id}     メモ取得
PUT    /memo/{id}     メモ更新
DELETE /memo/{id}     メモ削除
```

**POST /memo リクエスト:**
```json
{
  "content": "歯医者に行く",
  "type": "flash",
  "from": "2026-01-15",
  "until": null,
  "tags": ["健康/歯医者"]
}
```

**レスポンス:**
```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "content": "歯医者に行く",
  "type": "flash",
  "from": "2026-01-15",
  "until": null,
  "tags": ["健康/歯医者"],
  "date_added": "2026-01-09T10:30:00Z"
}
```

#### 6.1.3 検索

```
POST /search          認証済みユーザーの検索
POST /demo/search     デモユーザーの検索
POST /archive/search  アーカイブ検索（P2）
```

**POST /search リクエスト:**
```json
{
  "query": "クリニック",
  "filters": {
    "from_gte": "2026-01-01",
    "until_lte": "2026-01-31",
    "tags": ["健康"],
    "type": "flash"
  },
  "limit": 20
}
```

**レスポンス:**
```json
{
  "results": [
    {
      "id": "...",
      "content": "歯医者に行く",
      "score": 0.89,
      "tags": ["健康/歯医者"],
      "from": "2026-01-15",
      "date_added": "2026-01-09T10:30:00Z"
    }
  ],
  "total": 1
}
```

#### 6.1.4 タグ操作

```
GET /tags             タグ一覧（ツリー形式）
```

**レスポンス:**
```json
{
  "tags": [
    {
      "name": "健康",
      "path": "健康",
      "children": [
        {
          "name": "歯医者",
          "path": "健康/歯医者",
          "children": [
            {
              "name": "虫歯",
              "path": "健康/歯医者/虫歯",
              "children": []
            }
          ]
        }
      ]
    }
  ]
}
```

### 6.2 Python (FastAPI) エンドポイント

内部通信専用（外部非公開）

```
GET  /health          ヘルスチェック
POST /embed           テキストをベクトル化
```

**POST /embed リクエスト:**
```json
{
  "text": "passage: 歯医者に行く"
}
```

**レスポンス:**
```json
{
  "vector": [0.123, -0.456, ...]  // 768次元
}
```

**注意**: multilingual-e5モデルはプレフィックスが必要
- 保存時: `"passage: {content}"`
- 検索時: `"query: {query}"`

---

## 7. 検索システム

### 7.1 検索フロー

```
1. ユーザーが検索クエリを入力
2. SvelteKit (サーバーサイド) → Axum API
3. Axum → Python Embedder でクエリをベクトル化
4. Axum → Qdrant でベクトル検索 + フィルタ
5. 結果をスコアリング・ランキング
6. SvelteKit → ブラウザにレンダリング
```

### 7.2 スコアリングロジック

最終スコアは以下の重み付け合計：

| 要素 | 重み（仮） | 説明 |
|------|-----------|------|
| ベクトル類似度 | 0.6 | cosine similarity |
| アクセス頻度 | 0.2 | 正規化した access_count |
| 新しさ | 0.2 | date_added の新しさ |

**注意**: 重みは実際の使用感を見て調整。

### 7.3 日付フィルタの実装

ベクトル検索ではなく、Qdrant の payload フィルタで実現：

```python
# 今週の予定を取得
filter = {
    "must": [
        {"key": "from", "range": {"gte": "2026-01-06", "lte": "2026-01-12"}}
    ]
}
```

UI側で「今日」「今週」等のボタンを押すと、対応する日付範囲がフィルタに追加される。

### 7.4 タグ検索の実装

階層タグの親子検索は前方一致で実現：

```python
# "健康" で検索 → "健康/歯医者/虫歯" もヒット
filter = {
    "should": [
        {"key": "tags", "match": {"value": "健康"}},
        {"key": "tags", "match": {"text": "健康/"}}  # 前方一致
    ]
}
```

---

## 8. 認証・認可

### 8.1 認証フロー

```
┌──────────┐     ┌───────────────────┐     ┌─────────┐
│ Browser  │────▶│ Cloudflare Access │────▶│  Nginx  │
└──────────┘     │  (Google OAuth)   │     └────┬────┘
                 └───────────────────┘          │
                          │                     ▼
                          │              ┌───────────┐
                          └─────────────▶│ SvelteKit │
                            JWT Header   └─────┬─────┘
                                               │
                                               ▼
                                         ┌───────────┐
                                         │  Axum API │
                                         └───────────┘
```

### 8.2 JWT検証

Cloudflare Access は `Cf-Access-Jwt-Assertion` ヘッダーにJWTを付与。

Axum側で検証：
1. JWTの署名を検証（Cloudflareの公開鍵を使用）
2. 有効期限を確認
3. aud (audience) を確認

### 8.3 認証状態による分岐

| 状態 | 判定 | 動作 |
|------|------|------|
| 認証済み | JWT有効 | `memos` コレクションへアクセス |
| デモモード | JWT無効 or なし | `memos_demo` コレクションへアクセス、読み取り専用 |

### 8.4 権限

認証済みユーザーは全員同一権限：
- メモの追加・編集・削除
- 検索
- タグ管理

---

## 9. UI/UX 設計

### 9.1 フレームワーク・スタイリング

| 項目 | 選定 |
|------|------|
| フレームワーク | SvelteKit (SSR) |
| スタイリング | SCSS |
| CSS設計 | Svelteのスコープドスタイルに任せる |
| デザイントークン | SCSS変数で管理 |

### 9.2 レスポンシブ対応

- モバイルファースト
- ブレークポイント: 768px (タブレット), 1024px (デスクトップ)

### 9.3 主要画面

#### 9.3.1 メイン画面（検索・一覧）

- 検索バー（上部固定）
- フィルタフィールド（日付、タグ）
- 日付ショートカットボタン（今日、明日、今週、来週、今月）
- 検索結果リスト
- メモ追加ボタン（FAB: Floating Action Button）

#### 9.3.2 メモ追加画面

- 本文入力（複数行テキストエリア）
- 種別選択（フラッシュ / 永続）→ 簡単に切り替え可能
- 日付入力（from / until）
- タグ入力（予測変換 + ブロック化UI）

#### 9.3.3 タグ管理画面

- ツリービュー表示
- タグの追加・編集・削除

#### 9.3.4 アーカイブ画面（P2）

- アーカイブ専用検索
- 復元機能なし（閲覧のみ）

### 9.4 検索UI詳細

| 項目 | 仕様 |
|------|------|
| 検索実行 | Enterキーで実行（リアルタイム更新は負荷を考慮して見送り） |
| 結果表示 | プレビュー付きリスト |
| ページネーション | 無限スクロール or ページング（後で決定） |

### 9.5 タグ入力UI詳細

Google Docsの編集者追加UIを参考：

1. テキスト入力開始
2. 既存タグの予測変換がドロップダウン表示
3. 選択 or コンマ入力でタグがブロック化
4. ブロックにホバーで×ボタン表示
5. クリックでタグ削除
6. Backspaceで直前のタグ削除

---

## 10. インフラストラクチャ

### 10.1 Docker Compose 構成

```
┌─────────────────────────────────────────────────────────┐
│  Proxmox VM (Ubuntu)                                    │
│  ┌────────────────────────────────────────────────────┐ │
│  │  Docker Compose                                    │ │
│  │                                                    │ │
│  │  ┌──────────────────────────────────────────────┐ │ │
│  │  │  nginx (port 80)                              │ │ │
│  │  │  - 静的ファイル配信                            │ │ │
│  │  │  - リバースプロキシ → sveltekit:3000          │ │ │
│  │  └──────────────────────────────────────────────┘ │ │
│  │                                                    │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌───────────┐ │ │
│  │  │  sveltekit  │  │    api      │  │  qdrant   │ │ │
│  │  │  (Node.js)  │  │   (Rust)    │  │ (VectorDB)│ │ │
│  │  │  :3000      │  │   :8080     │  │  :6333    │ │ │
│  │  └─────────────┘  └─────────────┘  └───────────┘ │ │
│  │         │                │                        │ │
│  │         │                ▼                        │ │
│  │         │         ┌─────────────┐                │ │
│  │         │         │  embedder   │                │ │
│  │         │         │  (Python)   │                │ │
│  │         └────────▶│  :5000      │                │ │
│  │                   └─────────────┘                │ │
│  └────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
         │
         ▼ Cloudflare Tunnel
    ultnote.com (Cloudflare Access)
```

### 10.2 サービス間通信

| 通信 | プロトコル | 備考 |
|------|-----------|------|
| Browser → Nginx | HTTPS | Cloudflare Tunnel経由 |
| Nginx → SvelteKit | HTTP | 内部通信 |
| SvelteKit → API | HTTP | 内部通信 |
| API → Embedder | HTTP | 内部通信 |
| API → Qdrant | HTTP/gRPC | 内部通信 |

### 10.3 ポート構成

| サービス | 内部ポート | 外部公開 |
|----------|-----------|---------|
| Nginx | 80 | ✓ (Tunnel経由) |
| SvelteKit | 3000 | ✗ |
| API (Axum) | 8080 | ✗ |
| Embedder (FastAPI) | 5000 | ✗ |
| Qdrant | 6333, 6334 | ✗ |

### 10.4 ボリューム

| パス | 用途 |
|------|------|
| ./qdrant_data | Qdrantデータ永続化 |
| ~/.cache/huggingface | モデルキャッシュ（ダウンロード時間短縮） |

### 10.5 リソース要件

| リソース | 最小 | 推奨 |
|---------|------|------|
| メモリ | 4GB | 8GB |
| ストレージ | 10GB | 20GB |
| CPU | 2コア | 4コア |

**注意**: multilingual-e5-base は約1.5GBのメモリを消費（モデルロード時）。

---

## 11. 開発方針

### 11.1 開発環境

| 項目 | 詳細 |
|------|------|
| 環境 | Docker Compose（ローカルでも本番と同じ構成） |
| ホットリロード | 各サービスで対応 |

### 11.2 バージョン管理

| 項目 | 詳細 |
|------|------|
| VCS | Git + Jujutsu (jj) |
| リモート | GitHub |
| ブランチ戦略 | 後で決定 |

### 11.3 ディレクトリ構成（予定）

```
ultnote/
├── docker-compose.yml
├── nginx/
│   └── nginx.conf
├── frontend/           # SvelteKit
│   ├── src/
│   ├── static/
│   └── Dockerfile
├── api/                # Rust (Axum)
│   ├── src/
│   ├── Cargo.toml
│   └── Dockerfile
├── embedder/           # Python (FastAPI)
│   ├── main.py
│   ├── requirements.txt
│   └── Dockerfile
├── docs/
│   ├── architecture.md
│   └── progress.md
└── README.md
```

### 11.4 既存コードからの変更点

| 項目 | 変更内容 |
|------|----------|
| ai-engine → embedder | ディレクトリ名変更 |
| core-api → api | ディレクトリ名変更 |
| モデル | multilingual-e5-large → multilingual-e5-base |
| PostgreSQL | 削除（Qdrant一本化） |
| rerank機能 | 一旦削除（後で再検討） |
| SvelteKit | 新規追加 |
| Nginx | 新規追加 |

---

## 12. 設計上の決定事項とその理由

### 12.1 Qdrant一本化（PostgreSQL不使用）

**決定**: メモデータ、メタデータ全てをQdrantに格納

**理由**:
- Qdrantのpayloadでメタデータ格納可能
- 別DBとの同期問題を回避
- インフラ構成のシンプル化

**トレードオフ**:
- 全文検索（部分一致）は不可 → ベクトル検索で代替

### 12.2 自然言語処理の不採用

**決定**: 「今週の予定」等のクエリを自然言語処理で解釈しない

**理由**:
- LLM依存を避けたい（コスト、依存関係）
- 日付フィルタはUIで明示的に提供
- シンプルな設計を優先

**代替手段**:
- 日付ショートカットボタン（今日、今週等）
- フィルタフィールドでの範囲指定

### 12.3 multilingual-e5-base の選択

**決定**: multilingual-e5-base（278M params）を使用

**理由**:
- largeは大きすぎる（560M params、メモリ消費大）
- baseでも十分な品質
- 日本語対応

### 12.4 階層タグの深度無制限

**決定**: タグ階層の深さを制限しない

**理由**:
- 技術的なデメリットが特にない
- payloadに文字列として格納、検索時は前方一致
- ユーザーの自由度を優先

### 12.5 アーカイブからの復元不可

**決定**: アーカイブは一方通行、復元機能なし

**理由**:
- シンプルな設計を優先
- 復元が必要なケースは稀
- 必要なら管理画面から直接操作

### 12.6 デモモードの分離

**決定**: デモ用に別コレクション（memos_demo）を用意

**理由**:
- 本番データとの完全分離
- デモデータの管理が容易
- セキュリティリスク低減

---

## 付録

### A. 用語集

| 用語 | 説明 |
|------|------|
| フラッシュメモ | 一時的なメモ。条件を満たすとアーカイブへ移動 |
| 永続メモ | 恒久的なメモ。自動移動なし |
| ベクトル検索 | 埋め込みベクトルの類似度による検索 |
| payload | Qdrantでベクトルに付随するJSONメタデータ |
| 階層タグ | スラッシュ区切りの階層構造を持つタグ |
| eyre | Rustのエラーハンドリングライブラリ。リッチなエラーレポートとコンテキスト追加が可能 |

### B. 参考リンク

- [Qdrant Documentation](https://qdrant.tech/documentation/)
- [SvelteKit Documentation](https://kit.svelte.dev/docs)
- [Axum Documentation](https://docs.rs/axum/latest/axum/)
- [eyre Documentation](https://docs.rs/eyre/latest/eyre/)
- [color-eyre Documentation](https://docs.rs/color-eyre/latest/color_eyre/)
- [multilingual-e5-base](https://huggingface.co/intfloat/multilingual-e5-base)
- [Cloudflare Access](https://developers.cloudflare.com/cloudflare-one/policies/access/)

### C. 今後の検討事項

- [ ] リランキングモデルの再導入（検索精度向上）
- [ ] バックアップ戦略
- [ ] 監視・ログ収集
- [ ] CI/CDパイプライン
- [ ] Obsidian連携MCP（別プロジェクト）

---

## 13. 実装状況 (2026-01-09 更新)

### 13.1 完了した機能

| 機能 | 状態 | 備考 |
|------|------|------|
| メモCRUD | ✅ 完了 | POST/GET/PUT/DELETE /memo |
| ベクトル検索 | ✅ 完了 | multilingual-e5-base、精度良好 |
| 日付フィルタ | ✅ 完了 | from_gte, until_lte |
| タグフィルタ | ✅ 完了 | 階層タグ対応 |
| タグ一覧 | ✅ 完了 | ツリー形式 |
| Cloudflare Access認証 | ✅ 完了 | JWT検証ミドルウェア |
| デモモード | ✅ 完了 | 認証なしで memos_demo を使用 |
| SvelteKit Frontend | ✅ 完了 | SSR、レスポンシブ対応 |
| Docker Compose | ✅ 完了 | 開発・本番両対応 |
| Cloudflare Tunnel | ✅ 完了 | docker-compose.prod.yml |

### 13.2 未実装 (P1/P2)

| 機能 | 優先度 | 備考 |
|------|--------|------|
| アーカイブ自動移動 | P1 | 日付経過後の自動移動 |
| アクセス頻度ランキング | P1 | スコアリングに反映 |
| タグ予測変換 | P1 | UI側のサジェスト |
| カスタムメタデータ | P2 | key-value形式 |
| アーカイブ検索 | P2 | 別画面から検索 |

### 13.3 技術的な注意点

| 項目 | 詳細 |
|------|------|
| Rust バージョン | 1.92+ 必須 (qdrant-client 1.16 の要件) |
| Qdrant ポート | gRPC は 6334 (REST は 6333) |
| Embedder | sentence-transformers 3.3.1 推奨 |
| SvelteKit | Svelte 5 runes 構文 ($state, $props, $derived) |

### 13.4 ディレクトリ構成

```
ultnote/
├── docker-compose.yml          # 開発用
├── docker-compose.prod.yml     # 本番用 (cloudflared 含む)
├── .env.example                # 環境変数テンプレート
├── nginx/
│   └── nginx.conf
├── frontend/                   # SvelteKit
│   ├── src/
│   │   ├── lib/
│   │   │   ├── api.ts
│   │   │   ├── types.ts
│   │   │   └── components/
│   │   │       ├── TagInput.svelte
│   │   │       ├── DateFilters.svelte
│   │   │       ├── MemoCard.svelte
│   │   │       ├── SearchResults.svelte
│   │   │       └── MemoModal.svelte
│   │   └── routes/
│   │       ├── +layout.svelte
│   │       └── +page.svelte
│   └── Dockerfile
├── api/                        # Rust (Axum)
│   ├── src/
│   │   ├── main.rs
│   │   ├── config.rs
│   │   ├── auth.rs
│   │   ├── error.rs
│   │   ├── models/
│   │   ├── routes/
│   │   └── services/
│   ├── Cargo.toml
│   └── Dockerfile
├── embedder/                   # Python (FastAPI)
│   ├── main.py
│   ├── requirements.txt
│   └── Dockerfile
├── scripts/
│   ├── deploy.sh
│   └── seed-demo.sh
└── docs/
    └── architecture.md
```
